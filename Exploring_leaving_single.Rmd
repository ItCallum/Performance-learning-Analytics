---
title: "Why_do_people_drop_out"
author: "Callum Simpson"
date: "21/11/2020"
output: html_document
---

```{r setup, include=FALSE}

setwd("CSC8631_202021")
library('ProjectTemplate')
load.project()

```


## Business understanding

The data given is from Future Learn about data they have retrieved about there course over a number of cycles. I am going to look over the data to find an interesting aspect of the data and try and find a reason for it. 



## data_check

The following is me checking over my data. I have combined all the data relating to the reasons why people left.

I wanted to check the quality of the data as I by the looks of it thr recording why people left only occured during cycle 4 which suggest that it was a system added halfway through the process.

As I have merged all the data into one set I have added in a new coloum called cycle which is the number of the cycle the data relates to.

There are 403 rows and 9 variable columns 

```{r data_check}

combine_Leaving

dim(combine_Leaving)

```

## ID variables 

As 2 of our variables are relating an id I wanted to check to make sure that our dataset didn't contain any duplicates.

We see that id has no duplicates but learner_id did contain some duplicate ids.

From a check for duplicates we find that for the most part are the same learner id but in a different cycle suggesting that we have a few people who are leaving in one cycle but rejoining another cycle only to leave again. 

If we look at duplaices of learner_id and cycle we find 15 occurrences. For the most part we find alot of these duplicates are within a few minuets of each other.

To be safe I decided to remove all these duplicate values

```{r ID_Var_dups}

table(duplicated(combine_Leaving$id,fromLast=TRUE))

table(duplicated(combine_Leaving$learner_id,fromLast=TRUE))

duplicated_learner_id <- combine_Leaving %>% group_by(learner_id) %>% filter(n() != 1) 

duplicated_learner_id[order(duplicated_learner_id$learner_id),] 

duplicated_learner_id  %>% group_by(learner_id,Cycle) %>% filter(n() != 1)

combine_Leaving

combine_Leaving %>% 
  group_by(learner_id,Cycle) %>% 
  filter(n()==1)


```

## how_many_people_left 

Next I wanted to see how many people left each cycle 

As we can see there was almost double the amount of people leaving in cycle 5 as compared to other cycles

```{r how_many_people_left}

ggplot(combine_Leaving_NoDups, aes(Cycle)) + geom_bar() +
geom_text(stat='count', aes(label=..count..), vjust=1)  + ggtitle("How many people left per cycle")

```
## Reason for leaving

As we can see the reason why people leave the course we can try to find the main reason for people leaving. 

The majority of the people leaving have left as they don't have enough time or for another unknown reason (other). There dost seem to be alot of people leaving because the course was too easy 

If we split the results into the cycle they where achieved from we see that in cycle 6 and 7 the majority of people left because they didn't have time
We also see that in cycle 5 the dominate reason was for some unkown issue. This is the cycle that had the most drop outs so this suggest that this cycle contained a 'unique' issues that might of only occurred during this cycle and cause alot of people to leave.

```{r The_reason_given_to_why_people_left}

ggplot(combine_Leaving_NoDups, aes(leaving_reason)) + geom_bar() + 
  coord_flip() + ggtitle("The reasons why people left")

ggplot(combine_Leaving_NoDups, aes(leaving_reason)) + geom_bar() + facet_wrap(~ Cycle, ncol = 2) + 
  coord_flip()  + ggtitle("The reasons why people left per cycle")



```

## why some many NA

It's quite clear that there is a alot of NA values in the last_completed_step , last_completed_week_number, last_completed_step_number but I wanted to find out why and if there is any correlation.

After replacing NA with zero we can get a count of each row we find that there is an equal amount of rows with NA rows (204).

After turning plotting the bar chart of last_completed_week_number I discovered that overlewaling these "NA"s values made up the most of the results for each cyle.
We also see that most people leave at the start or the end, not in middle (week 2)

When looking the last step people completed before people left we see that the majority of people left before they complete a step. However we can also see that there for all cycles there is a spike in the number of people leaving at step 20.

It would be interesting to find out the reason why these people left at this step (look at the reason given)

```{r how_many_people_left}

combine_Leaving_NoDups_Zero <- combine_Leaving_NoDups

combine_Leaving_NoDups_Zero[is.na(combine_Leaving_NoDups)] <- 0

combine_Leaving_NoDups_Zero


print("--last_completed_step--")
table(combine_Leaving_NoDups_Zero$last_completed_step)

print("--last_completed_week_number--")
table(combine_Leaving_NoDups_Zero$last_completed_week_number)

ggplot(combine_Leaving_NoDups_Zero, aes(last_completed_week_number)) + geom_bar() + facet_wrap(~ Cycle, ncol = 2) + ggtitle("The amount of leavers last completed week")

print("--last_completed_step_number--")
table(combine_Leaving_NoDups_Zero$last_completed_step_number) 

ggplot(combine_Leaving_NoDups_Zero, aes(last_completed_step_number)) + geom_bar() + ggtitle("The amount of leavers last completed step")
ggplot(combine_Leaving_NoDups_Zero, aes(last_completed_step_number)) + geom_bar() + facet_wrap(~ Cycle, ncol = 2) + ggtitle("The amount of leavers last completed step per cycle")
``` 

## The NA rows, the last_completed_step , last_completed_week_number, last_completed_step_numbe

When looking the last_completed_step , last_completed_week_number, last_completed_step_number rows which have NA values we found that they all contained 204 Na rows.
When we get all the rows that conaited NA we have 204. Which tells us if a record has NA for last_completed_step there will also not be a value for last_completed_week_number and last_completed_step_number.

We also see that for each of these rows we have last_completed_step_at has no value

This suggests that 
- Either something has wrong with data collection
- These people have left the course before they had done anything on the course 

If we plot out the reasons why these NA people left we find out that the majority left due to them not having enough time or for other reasons. If these people NA people are infact leaving at the start of the course this results sort of makes sense (they joined the course but discovered they didnt have much time to work on it so they to leave at the start)

```{r how_many_people_left}



Check_Na <- combine_Leaving_NoDups[rowSums(is.na(combine_Leaving_NoDups)) > 0,]

Check_Na

ggplot(Check_Na, aes(leaving_reason)) + geom_bar() + 
  coord_flip() + ggtitle("The reason why people left but didnt complete a step")


```

## The day people left

The last column we should look at is the left_at. This is moment in time where a person left there course.

For this i had to do some work on the database (now called combine_Leaving_clean). I have changed left_at to a actual time step and then split it onto two new columns Date and time. This was so I could create an upcoming plot that I believe would be useful. I also turned last_completed_step,last_completed_week_number
,last_completed_step_number and Cycle.


The left_at value is very spefic moment in time. Also to really understand the moments people left we are going to need to split the result into there original cycles (as they leave one after the another) 

When all the leavers are all plotted we clearly see that there is alot of spread of last completed step within each cycle. My previous hypthosies was that there would be alot of people leaving at the start but it seems fairly spread out. There are people that are leaving near the end that havnt completed a week.

It would be interesting if we could get the course start dates. That is something that I would need to find.

```{r left_at_time}

##combine_Leaving_NoDups[is.na(combine_Leaving_NoDups)] <- 0

##combine_Leaving_NoDups

##combine_Leaving_date <- combine_Leaving_NoDups %>% mutate(Date = as.Date(left_at))
#output))

##combine_Leaving_date$left_at <- as.POSIXct(combine_Leaving_date$left_at,format="%Y-%m-%d %H:%M:%S") 

##combine_Leaving_date <- combine_Leaving_date %>% mutate(Time = format(ymd_hms(left_at), format = c("%H:%M:%S")))

##combine_Leaving_date <- combine_Leaving_date %>% mutate(Time = strftime(left_at, format="%H"))

##combine_Leaving_date

##combine_Leaving_date$Time <- format(strptime(combine_Leaving_date$Time, "%H:%M:%S"), "%H:%M")  # 24-hour

##combine_Leaving_date$Time <- as.POSIXct(combine_Leaving_date$Time, format = "%H:%M:%S")
  
## combine_Leaving_date

combine_Leaving_clean

combine_Leaving_clean %>% filter(Cycle == 4) %>%  ggplot(aes(x=Date, y=Time, color=last_completed_week_number)) + geom_point()
combine_Leaving_clean %>% filter(Cycle == 5) %>%  ggplot(aes(x=Date, y=Time, color=last_completed_week_number)) + geom_point()
combine_Leaving_clean %>% filter(Cycle == 6) %>%  ggplot(aes(x=Date, y=Time, color=last_completed_week_number)) + geom_point()
combine_Leaving_clean %>% filter(Cycle == 7) %>%  ggplot(aes(x=Date, y=Time, color=last_completed_week_number)) + geom_point()


ggplot(combine_Leaving_clean, aes(x=Date, y=Time, color=last_completed_week_number),  yaxt = "n") + geom_point()+ facet_wrap(~ Cycle, ncol = 1) + theme(legend.position="bottom")+
  theme(axis.text.y=element_blank(),axis.ticks.y=element_blank()) + ggtitle("When did people leave each cycle")

```

