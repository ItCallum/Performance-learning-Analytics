---
title: "Who_is_leaving"
author: "Callum Simpson"
date: "29/11/2020"
output: html_document
---

```{r setup, include=FALSE}

setwd("Project/CSC8631_202021")

library('ProjectTemplate')
load.project()

```

## How many people didnt leave the course 

We see that there are 1279 cases of people with unenrolled_at dates.

```{r cars}

combine_Enrolments

table(combine_Enrolments$Cycle)

table(combine_Leaving_clean_v2$Cycle)

leave_V_complete <- data.frame(table(combine_Enrolments$Cycle),table(combine_Leaving_clean_v2$Cycle) ) %>% mutate(Completed = Freq - Freq.1 , Percenatge = (Freq.1 / Freq)* 100 ) %>% 
  rename(Cycle = Var1, Leavers = Freq.1,Total_reg = Freq)

drop <- c("Var1.1")
df = leave_V_complete[,!(names(leave_V_complete) %in% drop)]

df

sum(combine_Enrolments$unenrolled_at != "")
  
```

## merged_data

For my set set on analysis i wanted to add in the users Enrollments data to in order to find out more information about the people that left.

The new data included is 

- Gender
- Enrolled time 
- role
- age range
- highest_education_level
- employment_status
- employment_area
- detected_country

```{r pressure, echo=FALSE}
merged_data
```

## About the users 1

Looking at the columns gender, Country and age range we see that the majority of these columns are dominated by Unknown data. This mat be cause by the users not wanting to enter any personal data about themselves or some issue when collecting the data. 

We can see that not all the Unknowns are the same size so this tells us that it might not be an error in collecting data as you would expect that all data the same rows would be unknown and not diffrent sizes. This suggest that there is a fair few users that are not wanting to give information  

```{r pressure, echo=FALSE}
table(merged_data$gender)

table(merged_data$country)

table(merged_data$age_range)


```

##Detected country

There is two columns that both contain country data, country which i'm guessing what the user entered and detected_country which is probably and automatic check that has been run without the user knowing and recorded.

Doing a table we see that there is alot more of a variety in the data detected_country than country (as there inst any unknown values).

Doing a check of all known counties vs the results of detected_country we see that there is 108 similarities and 8 Differences.

Looking at the rows that returned false we see that there is 4 rows with no detected_country. Suggesting that these users are using a VPN of some description.

Due to the fact we have alot of unkowns in country i will use detected_country to say where a user is from.


```{r pressure, echo=FALSE}

table(merged_data$country)

table(merged_data$detected_country)

df_same_country <- merged_data %>% filter(country != "Unknown") %>% mutate(same_country = ifelse(detected_country == country, TRUE, FALSE) ) 

df_same_country %>% count(same_country)

df_same_country %>% filter(same_country == FALSE )


```

## About the users 2

After looking at the area of user 

- role
- highest_education_level
- employment_status
- employment_area

Looking at these variables we see that there is a large amount of unknowns in each columns. I think this is primalry due to users dont wanting to say what they do, maybe there is inst the option to exactly state what the user does/is.

```{r pressure, echo=FALSE}

table(merged_data$role)

table(merged_data$highest_education_level)

table(merged_data$employment_status)

table(merged_data$employment_area)
```

## Two leaving dates.

Looking at the unenrolled_at time we see that there is 5 records that dont have an unenrolled_at time but do have a left_at time. We see near all of these happen in the 3rd week. This is somthing that I am going to have to look at 

As the enrollment data had its own recording of when a user left i decided to look at if this matched the left_at time in the leaving data.

We see out of all the leaver there was 8 miss matches. 5 of these where only a second out so this really inst a problem. 

The three other records where out by more than a month. I am unsure what i should do with these 3 values as i am unsure what caused this. I feel like I will keep them in, I'm assuming that the left at time is correct time and the unenrolled at is the time at which they where formally removed from the course. I.e a user leaves the course, it gets recorded 2 times but the time recorded in unenrolled_at didn't get added? This would somewhat explain why there is NA values.

At first I thought that there might be duplicates user entries in the enrollment data per cycle

```{r pressure, echo=FALSE}

merged_data

subset(merged_data, is.na(merged_data$unenrolled_at)) %>% select(left_at , unenrolled_at, Cycle, last_completed_week_number,last_completed_step)

merged_data %>% filter(left_at != unenrolled_at) %>% select(left_at , unenrolled_at, Cycle, last_completed_week_number)

combine_Enrolments %>% filter(combine_Leaving_clean_v2$learner_id != combine_Enrolments$learner_id)

```

##IS there duplicates in the enrole data

This error of the users having two different leaving dates was weird so I wanted to see if it is because we have duplicate user entries in the same cycle. If we merged the data then it may be possible that it got the wrong users enrollment data if there was two different entries for the same user. 

Doing a duplicate check we see that there are infarct 114 occurance of duplicate users but a later check shows that these where all across sperate cycles so the assumption of duplicate enrolment data in the same cycle dosnt hold.

```{r Duplicates_In_enrole, echo=FALSE}

is_there_duplicates <- combine_Enrolments %>% filter(learner_id %in% combine_Leaving_clean_v2$learner_id) 

duplicated_learner_id <- is_there_duplicates %>% group_by(learner_id) %>% filter(n() != 1) 

duplicated_learner_id[order(duplicated_learner_id$learner_id),] 

duplicated_learner_id  %>% group_by(learner_id,Cycle) %>% filter(n() != 1)

```

## Did anyone enrole after they left

No

```{r pressure, echo=FALSE}

merged_data

merged_data %>% filter(left_at < enrolled_at)



```
